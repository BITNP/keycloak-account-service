if(location.search.indexOf("checkSession=1")>=0&&window.opener)window.close();else if(window.Vue){var importByGroupLimit=100,executeSleepTime=400,openLoginWindow=function(){window.open("?checkSession=1","checkSessionWindow")},axiosGlobalCatch=function(e){if(e.response&&401==e.response.status)return alert("请刷新页面重新登录。"),void openLoginWindow();e.response?alert("请求失败 ("+e.response.status+"): "+JSON.stringify(e.response.data)):alert("请求失败: "+e.message)};Vue.component("comp-importer",{props:{userList:Array},data:function(){return{importByGroupPath:"",importByGroupFirst:0,importByGroupProcessing:!1,importByListText:sessionStorage.groupbatch_importByListText||""}},watch:{importByListText:function(e){sessionStorage.groupbatch_importByListText=e}},mounted:function(){sessionStorage.groupbatch_importByListText&&jQuery(this.$refs["import-tabs-by-list"]).tab("show")},methods:{importByGroup:function(e){e&&e.preventDefault();var t=this.addItem,r=this;r.importByGroupProcessing=!0,axios({method:"GET",url:"./",params:{path:this.importByGroupPath,first:this.importByGroupFirst},headers:{Accept:"application/json"}}).then(function(e){e.data[0].members.forEach(function(e){t(e)}),e.data[0].members.length>=importByGroupLimit&&(alert("本组成员较多，目前只请求了 "+importByGroupLimit+" 项结果，将为你修改表单中的数字，但你需要手动点击加载成员，继续加载成员。"),r.importByGroupFirst=r.importByGroupFirst+e.data[0].members.length),0==e.data[0].members.length&&alert("你的请求条件下没有返回结果。这通常表示你不需要继续加载成员，或数字设置得过大。")}).catch(axiosGlobalCatch).finally(function(){r.importByGroupProcessing=!1})},importByList:function(e){e&&e.preventDefault();var t=this.addItem;this.importByListText.split("\n").forEach(function(e){var r=e.trim();""!=r&&t({username:r})}),this.importByListText=""},addItem:function(e){var t=-1;if(this.userList.some(function(r,i){if(r.username==e.username||r.email==e.username)return t=i,!0}),-1==t)null==e.opState&&(e.opState=0),e.errorMessage="",e.metaLoading=!1,this.userList.push(e);else{if(this.userList[t].email==e.username)return;Vue.set(this.userList,t,Object.assign({},this.userList[t],e))}}}}),Vue.component("comp-list",{props:{userList:Array},template:"#comp-list-template",methods:{removeItem:function(e){this.userList.splice(e,1)},clearError:function(e){this.userList[e].errorMessage=""},loadItemMeta:function(e){var t=this.userList,r=t[e];r.metaLoading=!0,axios({method:"GET",url:"../users/",params:{search:r.username},headers:{Accept:"application/json"}}).then(function(i){var s=i.data[0];i.data.length>1&&(s=i.data.filter(function(e){return e.username==r.username||e.email==r.email})[0]);s?Vue.set(t,e,Object.assign({},t[e],s)):r.errorMessage="找不到符合条件的用户"}).catch(function(e){e.response&&404==e.response.status?r.errorMessage="找不到符合条件的用户":axiosGlobalCatch(e)}).finally(function(){t[e].metaLoading=!1})}}}),Vue.component("comp-list-item",{props:{username:String,email:String,opState:Number,enabled:Boolean,name:String,createdTimestamp:String,index:Number,errorMessage:String,metaLoading:Boolean},template:"#comp-list-item-template",methods:{loadMeta:function(){this.errorMessage="Dev"}}}),Vue.component("comp-target",{props:{userList:Array,initialTargetPath:String,initialTargetInternalNote:String},data:function(){return{operation:"compare",userListPending:[],processing:!1,processingPromise:null,targetMembers:null,targetPath:this.initialTargetPath,targetInternalNote:this.initialTargetInternalNote}},computed:{pendingCount:function(){return this.userListPending.length}},watch:{operation:function(e){this.watchUserList()},userList:{deep:!0,handler:function(e){this.watchUserList()}},targetPath:function(e,t){this.targetInternalNote="",this.targetMembers=null,this.resetOpState()},processing:function(e){if(e){if(this.processingPromise)return this.processing=!1,void alert("正在等待未完成的操作，如需继续，请重新点击开始。");this.startNextExecution()}}},methods:{watchUserList:function(){this.userListPending=this.userList.filter(this.getUserListPendingFilter(!1))},getUserListPendingFilter:function(e){return"add"==this.operation?function(t){return 1!=t.opState&&(e||""==t.errorMessage)}:"remove"==this.operation?function(t){return-1!=t.opState&&(e||""==t.errorMessage)}:function(t){return 0==t.opState&&(e||""==t.errorMessage)}},toggleExecution:function(e){e&&e.preventDefault(),this.processing=!this.processing},clearDone:function(e){e&&e.preventDefault();var t=this.getUserListPendingFilter(!0);this.$emit("update:userList",this.userList.filter(t))},resetOpState:function(e){for(var t in e&&e.preventDefault(),this.userList)Vue.set(this.userList[t],"opState",0)},clearError:function(e){e&&e.preventDefault(),this.userList.forEach(function(e){e.errorMessage&&Vue.set(e,"errorMessage","")})},_executionPreCheck:function(){return!!this.processing&&(!!this.userListPending.length||(this.processing=!1,!1))},startNextExecution:function(){if(this._executionPreCheck()){var e=this.userListPending[0];return"add"==this.operation?this._executeAdd(e):"remove"==this.operation?this._executeRemove(e):"compare"==this.operation?this._executeCompare(e):(e.errorMessage="NotImplemented",this.sleepAndStartNextExecution())}},_executeError:function(e,t){if(e.response&&401==e.response.status)return Vue.set(t,"errorMessage","请刷新页面重新登录"),void openLoginWindow();e.response?Vue.set(t,"errorMessage",e.response.status+": "+JSON.stringify(e.response.data)):Vue.set(t,"errorMessage",e.message)},_executeAdd:function(e){var t=this,r="path="+encodeURIComponent(this.targetPath)+"&username="+encodeURIComponent(e.username);this.processingPromise=axios({method:"POST",url:"./member-add",headers:{"content-type":"application/x-www-form-urlencoded",Accept:"application/json"},data:r}).then(function(t){for(var r in t.data)Vue.set(e,r,t.data[r]);Vue.set(e,"opState",1)}).catch(function(r){return t._executeError(r,e)}).finally(function(){t.sleepAndStartNextExecution()})},_executeRemove:function(e){var t=this,r="path="+encodeURIComponent(this.targetPath)+"&username="+encodeURIComponent(e.username);this.processingPromise=axios({method:"POST",url:"./member-remove",headers:{"content-type":"application/x-www-form-urlencoded",Accept:"application/json"},data:r}).then(function(t){for(var r in t.data)Vue.set(e,r,t.data[r]);Vue.set(e,"opState",-1)}).catch(function(r){return t._executeError(r,e)}).finally(function(){t.sleepAndStartNextExecution()})},_executeCompare:function(e){var t=this,r=function(){t.processing?(t.targetMembers.some(function(t){if(t.username==e.username||t.email==e.username){if(null==e.enabled)for(var r in t)Vue.set(e,r,t[r]);return!0}return!1})?Vue.set(e,"opState",1):Vue.set(e,"opState",-1),t.sleepAndStartNextExecution()):t.processingPromise=null};null==this.targetMembers?this.processingPromise=this._executeCompareFetchPromise(0).then(r):(this.processingPromise=!0,r())},_executeCompareFetchPromise:function(e){var t=this;return axios({method:"GET",url:"./",params:{path:this.targetPath,first:e},headers:{Accept:"application/json"}}).then(function(r){if(null==t.targetMembers&&(t.targetMembers=[]),t.targetMembers.push.apply(t.targetMembers,r.data[0].members),r.data[0].members.length>=importByGroupLimit)return t._executeCompareFetchPromise(e+r.data[0].members.length)}).catch(function(e){t.processingPromise=null,t.processing=!1,axiosGlobalCatch(e)})},sleepAndStartNextExecution:function(){var e=this;return e.processingPromise=null,e.$nextTick(function(){e._executionPreCheck()&&setTimeout(function(){e.startNextExecution()},executeSleepTime)})}}});var view=new Vue({el:"#app",data:{userList:[],initialTargetPath:"",initialTargetInternalNote:""},mounted:function(){this.initialTargetPath=this.$el.dataset.targetPath,this.initialTargetInternalNote=this.$el.dataset.targetInternalNote}})}